<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Import/Export – Vokabeltrainer</title>
  <meta name="theme-color" content="#22c55e" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon-192.png" sizes="192x192" />
  <link rel="stylesheet" href="./style.css" />
  <style>
    .container { max-width: 980px; margin: 1rem auto; padding: 1rem; background: var(--card); border:1px solid #1f2937; border-radius:0.75rem; }
    .drop { border:2px dashed #374151; padding:1rem; text-align:center; border-radius:0.5rem; background:#0b1220; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-top:1rem; }
    textarea { width:100%; height:180px; background:#0b1220; color:var(--fg); border:1px solid #374151; border-radius:0.5rem; padding:0.5rem; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #374151; padding:0.4rem; }
    th { background:#0e1a2f; }
    .ok { color:#34d399; }
    .warn { color:#fbbf24; }
    .err { color:#f87171; }
    .actions { display:flex; gap:0.5rem; flex-wrap: wrap; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header class="app-header">
    <h1>Import/Export</h1>
    <div class="controls">
      <a class="secondary" href="./index.html">← Zurück zum Trainer</a>
      <button id="dlTemplateBtn" class="secondary">CSV‑Template herunterladen</button>
      <button id="exportJsonBtn" class="secondary">Vokabeln exportieren (JSON)</button>
      <button id="exportCsvBtn" class="secondary">Vokabeln exportieren (CSV)</button>
    </div>
  </header>

  <main class="container">
    <p>Importformat (**;** bevorzugt, **,** wird erkannt): <code>unit;de;en</code> – z. B. <code>u1;Schule;school</code>. Units bitte als <code>u1..u7</code> benennen.</p>

    <div class="grid">
      <div>
        <div class="drop" id="dropZone">Datei hierher ziehen (CSV) oder unten wählen</div>
        <div style="margin-top:0.5rem;display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
          <input id="fileInput" type="file" accept=".csv,text/csv" />
          <button id="parseBtn" class="primary">Parsen & Vorschau</button>
        </div>
      </div>
      <div>
        <label><strong>Oder CSV hier einfügen:</strong></label>
        <textarea id="csvText" placeholder="unit;de;en\nu1;Schule;school\nu1;Freund;friend"></textarea>
      </div>
    </div>

    <section style="margin-top:1rem;">
      <h3>Vorschau</h3>
      <div id="previewInfo" class="muted">Noch keine Daten geparst.</div>
      <div class="actions" style="margin:0.5rem 0;">
        <button id="mergeBtn" class="primary" disabled>Mit vorhandenen Daten <strong>zusammenführen</strong></button>
        <button id="replaceBtn" class="secondary" disabled>Ausgewählte Units <strong>ersetzen</strong></button>
      </div>
      <div id="previewTableWrap"></div>
    </section>
  </main>

  <script>
  const LS_VOCAB = 'vocab-data-v1';
  const LS_STATS = 'vocab-trainer-stats-v4';

  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const parseBtn = document.getElementById('parseBtn');
  const csvText = document.getElementById('csvText');
  const previewInfo = document.getElementById('previewInfo');
  const mergeBtn = document.getElementById('mergeBtn');
  const replaceBtn = document.getElementById('replaceBtn');
  const previewTableWrap = document.getElementById('previewTableWrap');
  const dlTemplateBtn = document.getElementById('dlTemplateBtn');
  const exportJsonBtn = document.getElementById('exportJsonBtn');
  const exportCsvBtn = document.getElementById('exportCsvBtn');

  const UNITS = ['u1','u2','u3','u4','u5','u6','u7'];

  function loadVocab(){
    try{ return JSON.parse(localStorage.getItem(LS_VOCAB) || '{}'); } catch(e){ return {}; }
  }
  function saveVocab(v){ localStorage.setItem(LS_VOCAB, JSON.stringify(v)); }
  function loadStats(){ try{ return JSON.parse(localStorage.getItem(LS_STATS) || '{}'); } catch(e){ return {}; } }
  function saveStats(s){ localStorage.setItem(LS_STATS, JSON.stringify(s)); }

  function parseCSV(raw){
    // support ; (default) and , delimiters; ignore empty lines; skip header if matches unit;de;en
    raw = raw.replace(/\r\n?/g, '\n');
    const lines = raw.split('\n').map(l=>l.trim()).filter(Boolean);
    const out = [];
    for (let line of lines){
      // split by ; first, fallback to ,
      let parts = line.split(';');
      if (parts.length < 3) parts = line.split(',');
      if (parts.length < 3) continue;
      let [unit,de,en] = parts.map(s=>s.trim());
      if ((unit==='unit' && de==='de' && en==='en')) continue; // header
      if (!UNITS.includes(unit)) continue;
      if (!de || !en) continue;
      out.push({ unit, de, en });
    }
    return out;
  }

  function groupByUnit(rows){
    const grouped = {};
    rows.forEach(r => { if(!grouped[r.unit]) grouped[r.unit]=[]; grouped[r.unit].push({de:r.de, en:r.en}); });
    return grouped;
  }

  function renderPreview(grouped){
    const units = Object.keys(grouped);
    if (!units.length){ previewInfo.textContent = 'Keine gültigen Zeilen gefunden.'; previewTableWrap.innerHTML=''; mergeBtn.disabled = replaceBtn.disabled = true; return; }
    const total = units.reduce((acc,u)=>acc+grouped[u].length,0);
    previewInfo.textContent = `${total} Einträge in ${units.length} Unit(s) bereit.`;
    let html = '<table><thead><tr><th>Unit</th><th>Deutsch</th><th>Englisch</th></tr></thead><tbody>';
    units.forEach(u => {
      grouped[u].forEach(w => {
        html += `<tr><td>${u}</td><td>${escapeHtml(w.de)}</td><td>${escapeHtml(w.en)}</td></tr>`;
      });
    });
    html += '</tbody></table>';
    previewTableWrap.innerHTML = html;
    mergeBtn.disabled = replaceBtn.disabled = false;
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  let parsedGrouped = {};

  async function handleParse(){
    let raw = csvText.value;
    if (!raw && fileInput.files && fileInput.files[0]){
      raw = await fileInput.files[0].text();
    }
    parsedGrouped = groupByUnit(parseCSV(raw));
    renderPreview(parsedGrouped);
  }

  function mergeData(){
    const vocab = loadVocab();
    const stats = loadStats();
    if (!stats.blocks) stats.blocks={}; if (!stats.words) stats.words={};

    Object.keys(parsedGrouped).forEach(unit => {
      if (!vocab[unit]) vocab[unit]=[];
      const existingKeys = new Set(vocab[unit].map(w => key(w)));
      parsedGrouped[unit].forEach(w => { if (!existingKeys.has(key(w))) vocab[unit].push(w); });
      ensureStatsInitForUnit(stats, unit, vocab[unit]);
    });
    saveVocab(vocab); saveStats(stats);
    alert('Zusammenführen abgeschlossen. Zurück zum Trainer und neu laden.');
  }

  function replaceUnits(){
    const vocab = loadVocab();
    const stats = loadStats();
    if (!stats.blocks) stats.blocks={}; if (!stats.words) stats.words={};

    Object.keys(parsedGrouped).forEach(unit => {
      vocab[unit] = parsedGrouped[unit];
      ensureStatsInitForUnit(stats, unit, vocab[unit]);
    });
    saveVocab(vocab); saveStats(stats);
    alert('Ersetzen abgeschlossen. Zurück zum Trainer und neu laden.');
  }

  function ensureStatsInitForUnit(stats, unit, words){
    if (!stats.blocks[unit]) stats.blocks[unit] = {correct:0, wrong:0};
    if (!stats.words[unit]) stats.words[unit] = {};
    words.forEach(w => { const k = key(w); if (!stats.words[unit][k]) stats.words[unit][k] = {correct:0, wrong:0}; });
  }

  function key(w){ return (w.de||'').trim().toLowerCase()+'|'+(w.en||'').trim().toLowerCase(); }

  // Drag & Drop
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background='#0e1a2f'; });
  dropZone.addEventListener('dragleave', e => { dropZone.style.background='#0b1220'; });
  dropZone.addEventListener('drop', async e => {
    e.preventDefault(); dropZone.style.background='#0b1220';
    const file = e.dataTransfer.files[0]; if (!file) return; fileInput.files = e.dataTransfer.files; const text = await file.text(); csvText.value = text; await handleParse();
  });

  parseBtn.addEventListener('click', handleParse);
  mergeBtn.addEventListener('click', mergeData);
  replaceBtn.addEventListener('click', replaceUnits);

  // Template Download
  dlTemplateBtn.addEventListener('click', () => {
    const sample = 'unit;de;en\n' +
                   'u1;Schulhof;school yard\n' +
                   'u1;Freundschaft;friendship\n' +
                   'u2;Wochenende;weekend\n' +
                   'u3;Sehenswürdigkeit;sight';
    download('vocab-template.csv', sample);
  });

  // Export JSON/CSV
  exportJsonBtn.addEventListener('click', () => {
    const vocab = loadVocab();
    download('vocab-export.json', JSON.stringify(vocab, null, 2));
  });
  exportCsvBtn.addEventListener('click', () => {
    const vocab = loadVocab();
    const lines = ['unit;de;en'];
    Object.keys(vocab).forEach(unit => {
      (vocab[unit]||[]).forEach(w => lines.push(`${unit};${w.de};${w.en}`));
    });
    download('vocab-export.csv', lines.join('\n'));
  });

  function download(name, content){
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
  }
  </script>
</body>
</html>
